# Preview ![GitHub](https://img.shields.io/github/license/preview/lievecycle) ![GitHub last commit](https://img.shields.io/github/last-commit/livecycle/preview)

![Terminal GIF](./terminal.gif)


Preview is a CLI tool for provisioning preview environments.  
Using preview, you can provision `any docker compose app on your favorite cloud (currently AWS is only supported)    
This project is part of Liveycle's vision of making preview environments mainstream and integral part of any development flow.  

## Why?

Preview environments are non-production ephemeral environments that are created for each pull request.  
Such environments, can be extremely useful for improving PR workflows and became quite common in the latest years and even been deeply integrated by some PaaS providers (most notability in FE delivery platforms).  

Despite the value of preview environments, setting up preview environments can be a non-trivial task in terms of automation, configuration, operation, complexity and cost.  

This tool designed to simplify this process and provide a framework for utilizing preview environments in order to optimize the PR flow.  

You can read more about the story and philosophy behind this CLI here.  

## Getting started

To start using the CLI you first need:  
- a local AWS configuration (can be achieved by using the `aws login` or `aws configure`)  
- docker-compose application (example can be in awesome compose)  

You can install the CLI using npm:  
`npm install -g preview`  
or use it directly using:  
`npx preview <command>`  

Start by setting up a profile by using:  `preview init`  

Afterward, use `up` command to provision a new vm (lightsail) with your application.  
`preview up`  

Try accessing the application by using the `*.livecycle.run` urls generated for your app.  

Destroy the environment by using: `preview down`  

## Under the hood

The preview tool is composed of two main components:  

#### CLI (packages/cli)

The CLI is a node.js program responsible for:  
- Provisioning and tearing down VMs.
- Exposing environments' state and urls to end user. 
- Storing & accessing profile data. (settings, keys, etc...)
- Setup vm with Docker tooling
- Syncing compose source code and local volumes
- Running the application and install daemon for connecting to the proxy service.  

#### Tunnel server (packages/tunnel-server)

The tunnel server is a node.js base server responsible for exposing friendly HTTPS urls for the compose services.  
A free public instance is hosted on `livecycle.run` and it can be self-hosted as well.

A Docker/OCI image is available on ghcr.io:  ghcr.io/livecycle/preview/tunnel-server

## CI Integration

The preview CLI is designed to work as part of your CI.  
For accomplishing that, you need to have a shared profile stored in s3. (more storage provider are on the way)

It can be created by using `preview init` and choosing s3 url for storing the profile. (bucket will be created automatically if doesn't exist).

Afterward, the exact profile can be imported in the CI using `preview init --from <s3-url>`

[Examples]

## Security

In case you find a security issue or have something you would like to discuss refer to our security.md policy.

#### Notice on preview environments exposure
VMs are not exposed directly and instead are exposed via a tunnel created by the tunneling server.  
Every compose service is exposed with a generated url in the following format:  
`https://{service}-{[port]}-{envId}-{clientId}.{tunnel-server domain}`  
EnvId can be specified by the `up` command `id` flag, or by automatically generated by git context.  
ClientId is a unique identifier based on the profile's public tunneling SSH key (generated in init).  
When using the `*.livecycle.run`, all environments are publicly accessible, assuming you have knowledge of the urls.  

## Contributing
Found a bug? Have a missing feature? Please open an issue and let us know.
